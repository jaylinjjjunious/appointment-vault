<%- include("partials/top", { title }) %>
<%
  const safeHistoryAppointments =
    typeof historyAppointments !== "undefined" && Array.isArray(historyAppointments)
      ? historyAppointments
      : [];
  const safeCallStatus = typeof callStatus === "string" ? callStatus : "";
  const safeCallStatusMessage = typeof callStatusMessage === "string" ? callStatusMessage : "";
  const safeTestProfileActive =
    typeof testProfileActive !== "undefined" ? testProfileActive : false;
  const safeTestProfile =
    typeof testProfile !== "undefined" && testProfile ? testProfile : null;
  const safeGoogleConfigured =
    typeof googleConfigured !== "undefined" ? Boolean(googleConfigured) : false;
  const safeGoogleConnected =
    typeof googleConnected !== "undefined" ? Boolean(googleConnected) : false;
  const safeUser = typeof user !== "undefined" && user ? user : null;
  const safeReminderActivity =
    typeof reminderActivity !== "undefined" && reminderActivity && Array.isArray(reminderActivity.items)
      ? reminderActivity
      : { items: [], page: 1, pageSize: 20, total: 0 };
  const safeReminderStatus = typeof reminderStatus === "string" ? reminderStatus : "";
  const safeReminderChannel = typeof reminderChannel === "string" ? reminderChannel : "";
  const hasSavedPrefs = String((typeof query !== "undefined" && query ? query.prefs : "") || "") === "saved";
%>

<section class="page-heading settings-heading">
  <h1>Settings</h1>
  <p>Past appointments are automatically moved into History.</p>
</section>
<% if (hasSavedPrefs) { %>
  <section class="card glass-panel status-card">
    <p>Reminder settings saved.</p>
  </section>
<% } %>

<div data-tab-root class="settings-layout">
  <div class="tabs tabs-boxed mt-6">
    <a class="tab tab-active" href="#overview" data-tab="overview">Overview</a>
    <a class="tab" href="#appointments" data-tab="appointments">Appointments</a>
    <a class="tab" href="#checkin" data-tab="checkin">Check-In</a>
    <a class="tab" href="#activity" data-tab="activity">Activity</a>
    <a class="tab" href="#history" data-tab="history">History</a>
    <a class="tab" href="#errors" data-tab="errors">Error Finder</a>
  </div>

<% if (safeTestProfileActive && safeTestProfile) { %>
  <section class="calendar-section glass-panel" data-tab-panel="overview">
    <h2>Temporary Test Profile</h2>
    <p><strong>Name:</strong> <%= safeTestProfile.name %></p>
    <p><strong>Email:</strong> <%= safeTestProfile.email %></p>
    <p class="section-empty">This test profile auto-signs in on every page load.</p>
  </section>
<% } %>

<section id="overview" class="calendar-section glass-panel" data-tab-panel="overview">
  <h2>Google Calendar</h2>
  <% if (!safeGoogleConfigured) { %>
    <p class="section-empty">
      Google OAuth is not configured on this server yet.
    </p>
  <% } else if (safeTestProfileActive) { %>
    <p class="section-empty">
      Test profile mode is active and auto-connects calendar behavior.
    </p>
  <% } else if (safeGoogleConnected) { %>
    <p class="section-empty">Connected. You can disconnect below.</p>
    <form class="actions" action="/auth/google/disconnect" method="POST">
      <button class="button glass-button button-secondary" type="submit" data-activity="google_disconnect" data-activity-title="Disconnected Google Calendar">Disconnect Google Calendar</button>
    </form>
  <% } else { %>
    <p class="section-empty">Not connected yet.</p>
    <div class="actions">
      <a class="button glass-button" href="/auth/google" data-activity="google_connect" data-activity-title="Connected Google Calendar">Connect Google Calendar</a>
    </div>
  <% } %>
</section>

<section id="appointments" class="calendar-section glass-panel" data-tab-panel="appointments">
  <h2>Reminder Preferences</h2>
  <p class="section-empty">Voice first, with SMS fallback if voice fails.</p>
  <form class="form-grid" action="/settings/reminders" method="POST">
    <div class="form-row">
      <label class="checkbox-field" for="voiceEnabled">
        <input
          id="voiceEnabled"
          name="voiceEnabled"
          type="checkbox"
          value="true"
          <%= safeUser && Number(safeUser.voiceEnabled) === 1 ? "checked" : "" %>
        />
        <span>Enable Voice</span>
      </label>
      <label class="checkbox-field" for="smsEnabled">
        <input
          id="smsEnabled"
          name="smsEnabled"
          type="checkbox"
          value="true"
          <%= safeUser && Number(safeUser.smsEnabled) === 1 ? "checked" : "" %>
        />
        <span>Enable SMS fallback</span>
      </label>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label for="quietHoursStart">Quiet Hours Start</label>
        <input
          id="quietHoursStart"
          class="glass-input"
          name="quietHoursStart"
          type="time"
          value="<%= safeUser && safeUser.quietHoursStart ? safeUser.quietHoursStart : '' %>"
        />
      </div>
      <div class="form-field">
        <label for="quietHoursEnd">Quiet Hours End</label>
        <input
          id="quietHoursEnd"
          class="glass-input"
          name="quietHoursEnd"
          type="time"
          value="<%= safeUser && safeUser.quietHoursEnd ? safeUser.quietHoursEnd : '' %>"
        />
      </div>
    </div>
    <div class="form-field">
      <label for="timezone">Timezone</label>
      <input
        id="timezone"
        class="glass-input"
        name="timezone"
        type="text"
        value="<%= safeUser && safeUser.timezone ? safeUser.timezone : 'America/Los_Angeles' %>"
        placeholder="America/Los_Angeles"
      />
    </div>
    <div class="actions">
      <button class="button glass-button" type="submit">Save Reminder Settings</button>
    </div>
  </form>
</section>

<section class="calendar-section glass-panel" data-tab-panel="appointments">
  <h2>Call Test</h2>
  <p class="section-empty">Use this button to place a live Twilio test call.</p>
  <form class="actions" action="/settings/test-call" method="POST">
    <input type="hidden" name="minutes" value="30" />
    <button class="button glass-button" type="submit">Test Call</button>
  </form>
  <% if (safeCallStatusMessage) { %>
    <p class="<%= safeCallStatus === 'error' ? 'error-text' : '' %>"><%= safeCallStatusMessage %></p>
  <% } %>
</section>

<section id="checkin" class="calendar-section glass-panel" data-tab-panel="checkin">
  <h2>CE Check-In</h2>
  <p class="section-empty">Use the Calendar page for the embedded Check-In portal.</p>
  <div class="actions">
    <a class="button glass-button button-secondary" href="/calendar#checkin">Open Check-In Panel</a>
    <a
      class="button glass-button button-secondary"
      href="https://www.cecheckin.com/client/account/signin"
      target="_blank"
      rel="noopener noreferrer"
    >
      Open In New Tab
    </a>
  </div>
</section>

<section id="activity" class="calendar-section glass-panel" data-tab-panel="activity">
  <h2>Reminder Activity</h2>
  <p class="section-empty">Latest delivery attempts, retries, and fallbacks.</p>
  <form class="form-row" action="/settings" method="GET">
    <div class="form-field">
      <label for="statusFilter">Status</label>
      <select id="statusFilter" class="glass-input" name="status">
        <option value="" <%= !safeReminderStatus ? "selected" : "" %>>All</option>
        <option value="queued" <%= safeReminderStatus === "queued" ? "selected" : "" %>>Queued</option>
        <option value="calling" <%= safeReminderStatus === "calling" ? "selected" : "" %>>Calling</option>
        <option value="voice_failed" <%= safeReminderStatus === "voice_failed" ? "selected" : "" %>>Voice Failed</option>
        <option value="voice_no_answer" <%= safeReminderStatus === "voice_no_answer" ? "selected" : "" %>>No Answer</option>
        <option value="sms_sent" <%= safeReminderStatus === "sms_sent" ? "selected" : "" %>>SMS Sent</option>
        <option value="completed" <%= safeReminderStatus === "completed" ? "selected" : "" %>>Completed</option>
      </select>
    </div>
    <div class="form-field">
      <label for="channelFilter">Channel</label>
      <select id="channelFilter" class="glass-input" name="channel">
        <option value="" <%= !safeReminderChannel ? "selected" : "" %>>All</option>
        <option value="voice" <%= safeReminderChannel === "voice" ? "selected" : "" %>>Voice</option>
        <option value="sms" <%= safeReminderChannel === "sms" ? "selected" : "" %>>SMS</option>
      </select>
    </div>
    <div class="actions">
      <button class="button glass-button button-secondary" type="submit">Apply Filters</button>
    </div>
  </form>
  <% if (safeReminderActivity.items.length === 0) { %>
    <p class="section-empty">No reminder activity yet.</p>
  <% } else { %>
    <div class="list">
      <% safeReminderActivity.items.forEach((item) => { %>
        <article class="card glass-card appointment-card">
          <div class="appointment-main">
            <p><strong>Channel:</strong> <%= item.channel %></p>
            <p><strong>Status:</strong> <%= item.status %></p>
            <p><strong>Attempt #:</strong> <%= item.attemptNumber %></p>
            <p><strong>Scheduled:</strong> <%= item.scheduledFor %></p>
            <% if (item.providerSid) { %>
              <p><strong>Provider SID:</strong> <%= item.providerSid %></p>
            <% } %>
            <% if (item.errorMessage) { %>
              <p class="error-text"><strong>Error:</strong> <%= item.errorMessage %></p>
            <% } %>
          </div>
        </article>
      <% }) %>
    </div>
  <% } %>
</section>

<section id="history" class="calendar-section glass-panel" data-tab-panel="history">
  <h2>History</h2>
  <p class="section-empty">
    Click below to open your full history log.
    <% if (safeHistoryAppointments.length > 0) { %>
      (<%= safeHistoryAppointments.length %> appointment<%= safeHistoryAppointments.length === 1 ? "" : "s" %>)
    <% } %>
  </p>
  <button
    id="openHistoryModal"
    class="button glass-button button-secondary"
    type="button"
  >
    View History Log
  </button>
  <noscript>
    <a class="button glass-button button-secondary" href="/settings/history">Open History Page</a>
  </noscript>
  <p class="section-empty">If popup does not open, use <a href="/settings/history">History Page</a>.</p>
</section>

<section id="errors" class="calendar-section glass-panel" data-tab-panel="errors">
  <h2>Error Finder</h2>
  <p class="section-empty">Shows the most recent error report copied from the Server Error page.</p>
  <pre class="error-report__box" id="settingsErrorReport">No error report saved yet.</pre>
  <div class="actions">
    <button class="button glass-button button-secondary" type="button" id="copySavedError">Copy Saved Report</button>
    <button class="button glass-button button-secondary" type="button" id="clearSavedError">Clear Saved Report</button>
  </div>
</section>

<div id="historyModal" class="history-modal-backdrop" hidden aria-hidden="true">
  <section class="history-modal glass-panel" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
    <div class="history-modal-header">
      <h2 id="historyModalTitle">History Log</h2>
      <button id="closeHistoryModal" class="button glass-button button-secondary" type="button">
        Close
      </button>
    </div>
    <p class="section-empty">
      This history is saved and remembered.
    </p>
    <% if (safeHistoryAppointments.length === 0) { %>
      <p class="section-empty">No past appointments yet.</p>
    <% } else { %>
      <div class="list history-modal-list">
        <% safeHistoryAppointments.forEach((appointment) => { %>
          <article class="card glass-card appointment-card completed-card">
            <div class="appointment-main">
              <h3><strong><%= appointment.title %></strong></h3>
              <p><strong>Date:</strong> <%= appointment.date %></p>
              <p><strong>Time:</strong> <%= formatDisplayTime(appointment.time) %></p>
              <% if (appointment.location) { %>
                <p><strong>Location:</strong> <%= appointment.location %></p>
              <% } %>
              <% if (appointment.reminderMinutes !== null) { %>
                <p><strong>Reminder:</strong> <%= appointment.reminderMinutes %> min before</p>
              <% } %>
              <% if (Number(appointment.isRecurring) === 1) { %>
                <p><strong>Recurring:</strong> <code><%= appointment.rrule || "Yes" %></code></p>
              <% } %>
              <p class="completed-label">History</p>
            </div>
            <div class="actions">
              <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>">View</a>
              <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>/edit">Edit</a>
              <form action="/appointments/<%= appointment.id %>/delete" method="POST">
                <button class="button glass-button button-danger" type="submit">Delete</button>
              </form>
            </div>
          </article>
        <% }) %>
      </div>
    <% } %>
  </section>
</div>

</div>

<script>
  (() => {
    const root = document.querySelector("[data-tab-root]");
    if (!root) return;

    const tabs = Array.from(root.querySelectorAll("[data-tab]"));
    const panels = Array.from(root.querySelectorAll("[data-tab-panel]"));

    const activate = (key) => {
      panels.forEach((panel) => {
        panel.hidden = panel.getAttribute("data-tab-panel") !== key;
      });
      tabs.forEach((tab) => {
        const isActive = tab.getAttribute("data-tab") === key;
        tab.classList.toggle("tab-active", isActive);
      });
    };

    const hash = window.location.hash.replace("#", "");
    const normalized = hash === "reminders" ? "appointments" : hash;
    const initial = tabs.some((tab) => tab.getAttribute("data-tab") === normalized)
      ? normalized
      : "overview";
    activate(initial);

    tabs.forEach((tab) => {
      tab.addEventListener("click", (event) => {
        const key = tab.getAttribute("data-tab");
        if (!key) return;
        event.preventDefault();
        history.replaceState(null, "", `#${key}`);
        activate(key);
      });
    });
  })();
</script>

<script>
  (() => {
    const reportEl = document.getElementById("settingsErrorReport");
    const copyBtn = document.getElementById("copySavedError");
    const clearBtn = document.getElementById("clearSavedError");
    if (!reportEl) return;

    const loadReport = () => {
      let payload = "";
      try {
        payload = localStorage.getItem("av:lastErrorReport") || "";
      } catch (error) {
        payload = "";
      }
      reportEl.textContent = payload || "No error report saved yet.";
      if (copyBtn) {
        copyBtn.disabled = !payload;
      }
      if (clearBtn) {
        clearBtn.disabled = !payload;
      }
    };

    loadReport();

    if (copyBtn) {
      copyBtn.addEventListener("click", async () => {
        const payload = reportEl.textContent || "";
        if (!payload || payload.startsWith("No error report")) return;
        try {
          await navigator.clipboard.writeText(payload);
          copyBtn.textContent = "Copied!";
          setTimeout(() => {
            copyBtn.textContent = "Copy Saved Report";
          }, 1200);
        } catch (error) {
          copyBtn.textContent = "Copy failed";
        }
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        try {
          localStorage.removeItem("av:lastErrorReport");
          localStorage.removeItem("av:lastErrorTime");
        } catch (error) {
          // ignore localStorage failures
        }
        loadReport();
      });
    }
  })();
</script>

<script>
  (() => {
    const modal = document.getElementById("historyModal");
    const openButton = document.getElementById("openHistoryModal");
    const closeButton = document.getElementById("closeHistoryModal");

    if (!modal || !openButton || !closeButton) {
      return;
    }

    const setOpen = (isOpen) => {
      modal.hidden = !isOpen;
      modal.setAttribute("aria-hidden", isOpen ? "false" : "true");
      document.body.classList.toggle("modal-open", isOpen);
    };

    const armOpenButton = () => {
      openButton.disabled = true;
      setTimeout(() => {
        openButton.disabled = false;
      }, 450);
    };

    openButton.addEventListener("click", (event) => {
      if (openButton.disabled) {
        event.preventDefault();
        event.stopPropagation();
        return;
      }

      event.preventDefault();
      event.stopPropagation();
      setOpen(true);
    });

    closeButton.addEventListener("click", (event) => {
      event.preventDefault();
      event.stopPropagation();
      setOpen(false);
    });

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        setOpen(false);
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !modal.hidden) {
        setOpen(false);
      }
    });

    window.addEventListener("pageshow", () => {
      setOpen(false);
      armOpenButton();
    });

    setOpen(false);
    armOpenButton();
  })();
</script>

<script src="/public/livePanelsRefresh.js"></script>
<%- include("partials/bottom") %>
