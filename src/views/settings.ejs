<%- include("partials/top", { title }) %>
<%
  const safeHistoryAppointments =
    typeof historyAppointments !== "undefined" && Array.isArray(historyAppointments)
      ? historyAppointments
      : [];
  const safeCallStatus = typeof callStatus === "string" ? callStatus : "";
  const safeCallStatusMessage = typeof callStatusMessage === "string" ? callStatusMessage : "";
  const safeTestProfileActive =
    typeof testProfileActive !== "undefined" ? testProfileActive : false;
  const safeTestProfile =
    typeof testProfile !== "undefined" && testProfile ? testProfile : null;
  const safeUser = typeof user !== "undefined" && user ? user : null;
  const safeReminderActivity =
    typeof reminderActivity !== "undefined" && reminderActivity && Array.isArray(reminderActivity.items)
      ? reminderActivity
      : { items: [], page: 1, pageSize: 20, total: 0 };
  const safeReminderStatus = typeof reminderStatus === "string" ? reminderStatus : "";
  const safeReminderChannel = typeof reminderChannel === "string" ? reminderChannel : "";
  const hasSavedPrefs = String((typeof query !== "undefined" && query ? query.prefs : "") || "") === "saved";
%>

<section class="page-heading">
  <h1>Settings</h1>
  <p>Past appointments are automatically moved into History.</p>
</section>
<% if (hasSavedPrefs) { %>
  <section class="card glass-panel status-card">
    <p>Reminder settings saved.</p>
  </section>
<% } %>

<% if (safeTestProfileActive && safeTestProfile) { %>
  <section class="calendar-section glass-panel">
    <h2>Temporary Test Profile</h2>
    <p><strong>Name:</strong> <%= safeTestProfile.name %></p>
    <p><strong>Email:</strong> <%= safeTestProfile.email %></p>
    <p class="section-empty">This test profile auto-signs in on every page load.</p>
  </section>
<% } %>

<section class="calendar-section glass-panel">
  <h2>Reminder Preferences</h2>
  <p class="section-empty">Voice first, with SMS fallback if voice fails.</p>
  <form class="form-grid" action="/settings/reminders" method="POST">
    <div class="form-row">
      <label class="checkbox-field" for="voiceEnabled">
        <input
          id="voiceEnabled"
          name="voiceEnabled"
          type="checkbox"
          value="true"
          <%= safeUser && Number(safeUser.voiceEnabled) === 1 ? "checked" : "" %>
        />
        <span>Enable Voice</span>
      </label>
      <label class="checkbox-field" for="smsEnabled">
        <input
          id="smsEnabled"
          name="smsEnabled"
          type="checkbox"
          value="true"
          <%= safeUser && Number(safeUser.smsEnabled) === 1 ? "checked" : "" %>
        />
        <span>Enable SMS fallback</span>
      </label>
    </div>
    <div class="form-row">
      <div class="form-field">
        <label for="quietHoursStart">Quiet Hours Start</label>
        <input
          id="quietHoursStart"
          class="glass-input"
          name="quietHoursStart"
          type="time"
          value="<%= safeUser && safeUser.quietHoursStart ? safeUser.quietHoursStart : '' %>"
        />
      </div>
      <div class="form-field">
        <label for="quietHoursEnd">Quiet Hours End</label>
        <input
          id="quietHoursEnd"
          class="glass-input"
          name="quietHoursEnd"
          type="time"
          value="<%= safeUser && safeUser.quietHoursEnd ? safeUser.quietHoursEnd : '' %>"
        />
      </div>
    </div>
    <div class="form-field">
      <label for="timezone">Timezone</label>
      <input
        id="timezone"
        class="glass-input"
        name="timezone"
        type="text"
        value="<%= safeUser && safeUser.timezone ? safeUser.timezone : 'America/Los_Angeles' %>"
        placeholder="America/Los_Angeles"
      />
    </div>
    <div class="actions">
      <button class="button glass-button" type="submit">Save Reminder Settings</button>
    </div>
  </form>
</section>

<section class="calendar-section glass-panel">
  <h2>Call Test</h2>
  <p class="section-empty">Use this button to place a live Twilio test call.</p>
  <form class="actions" action="/settings/test-call" method="POST">
    <input type="hidden" name="minutes" value="30" />
    <button class="button glass-button" type="submit">Test Call</button>
  </form>
  <% if (safeCallStatusMessage) { %>
    <p class="<%= safeCallStatus === 'error' ? 'error-text' : '' %>"><%= safeCallStatusMessage %></p>
  <% } %>
</section>

<section class="calendar-section glass-panel checkin-panel">
  <h2>CE Check-In</h2>
  <p class="section-empty">Live CE Check-In portal loaded inside this panel.</p>
  <div class="actions">
    <a
      class="button glass-button button-secondary"
      href="https://cecheckin.com"
      target="_blank"
      rel="noopener noreferrer"
    >
      Open CE Check-In In New Tab
    </a>
  </div>
  <div class="checkin-embed-wrap">
    <iframe
      class="checkin-embed"
      src="https://cecheckin.com"
      title="CE Check-In Website"
      loading="eager"
      referrerpolicy="no-referrer-when-downgrade"
    ></iframe>
  </div>
  <p class="section-empty">
    If the site blocks embedding, use the open-in-new-tab button above.
  </p>
</section>

<section class="calendar-section glass-panel">
  <h2>Reminder Activity</h2>
  <p class="section-empty">Latest delivery attempts, retries, and fallbacks.</p>
  <form class="form-row" action="/settings" method="GET">
    <div class="form-field">
      <label for="statusFilter">Status</label>
      <select id="statusFilter" class="glass-input" name="status">
        <option value="" <%= !safeReminderStatus ? "selected" : "" %>>All</option>
        <option value="queued" <%= safeReminderStatus === "queued" ? "selected" : "" %>>Queued</option>
        <option value="calling" <%= safeReminderStatus === "calling" ? "selected" : "" %>>Calling</option>
        <option value="voice_failed" <%= safeReminderStatus === "voice_failed" ? "selected" : "" %>>Voice Failed</option>
        <option value="voice_no_answer" <%= safeReminderStatus === "voice_no_answer" ? "selected" : "" %>>No Answer</option>
        <option value="sms_sent" <%= safeReminderStatus === "sms_sent" ? "selected" : "" %>>SMS Sent</option>
        <option value="completed" <%= safeReminderStatus === "completed" ? "selected" : "" %>>Completed</option>
      </select>
    </div>
    <div class="form-field">
      <label for="channelFilter">Channel</label>
      <select id="channelFilter" class="glass-input" name="channel">
        <option value="" <%= !safeReminderChannel ? "selected" : "" %>>All</option>
        <option value="voice" <%= safeReminderChannel === "voice" ? "selected" : "" %>>Voice</option>
        <option value="sms" <%= safeReminderChannel === "sms" ? "selected" : "" %>>SMS</option>
      </select>
    </div>
    <div class="actions">
      <button class="button glass-button button-secondary" type="submit">Apply Filters</button>
    </div>
  </form>
  <% if (safeReminderActivity.items.length === 0) { %>
    <p class="section-empty">No reminder activity yet.</p>
  <% } else { %>
    <div class="list">
      <% safeReminderActivity.items.forEach((item) => { %>
        <article class="card glass-card appointment-card">
          <div class="appointment-main">
            <p><strong>Channel:</strong> <%= item.channel %></p>
            <p><strong>Status:</strong> <%= item.status %></p>
            <p><strong>Attempt #:</strong> <%= item.attemptNumber %></p>
            <p><strong>Scheduled:</strong> <%= item.scheduledFor %></p>
            <% if (item.providerSid) { %>
              <p><strong>Provider SID:</strong> <%= item.providerSid %></p>
            <% } %>
            <% if (item.errorMessage) { %>
              <p class="error-text"><strong>Error:</strong> <%= item.errorMessage %></p>
            <% } %>
          </div>
        </article>
      <% }) %>
    </div>
  <% } %>
</section>

<section class="calendar-section glass-panel">
  <h2>History</h2>
  <p class="section-empty">
    Click below to open your full history log.
    <% if (safeHistoryAppointments.length > 0) { %>
      (<%= safeHistoryAppointments.length %> appointment<%= safeHistoryAppointments.length === 1 ? "" : "s" %>)
    <% } %>
  </p>
  <button
    id="openHistoryModal"
    class="button glass-button button-secondary"
    type="button"
  >
    View History Log
  </button>
  <noscript>
    <a class="button glass-button button-secondary" href="/settings/history">Open History Page</a>
  </noscript>
  <p class="section-empty">If popup does not open, use <a href="/settings/history">History Page</a>.</p>
</section>

<div id="historyModal" class="history-modal-backdrop" hidden aria-hidden="true">
  <section class="history-modal glass-panel" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
    <div class="history-modal-header">
      <h2 id="historyModalTitle">History Log</h2>
      <button id="closeHistoryModal" class="button glass-button button-secondary" type="button">
        Close
      </button>
    </div>
    <p class="section-empty">
      This history is saved and remembered.
    </p>
    <% if (safeHistoryAppointments.length === 0) { %>
      <p class="section-empty">No past appointments yet.</p>
    <% } else { %>
      <div class="list history-modal-list">
        <% safeHistoryAppointments.forEach((appointment) => { %>
          <article class="card glass-card appointment-card completed-card">
            <div class="appointment-main">
              <h3><strong><%= appointment.title %></strong></h3>
              <p><strong>Date:</strong> <%= appointment.date %></p>
              <p><strong>Time:</strong> <%= formatDisplayTime(appointment.time) %></p>
              <% if (appointment.location) { %>
                <p><strong>Location:</strong> <%= appointment.location %></p>
              <% } %>
              <% if (appointment.reminderMinutes !== null) { %>
                <p><strong>Reminder:</strong> <%= appointment.reminderMinutes %> min before</p>
              <% } %>
              <% if (Number(appointment.isRecurring) === 1) { %>
                <p><strong>Recurring:</strong> <code><%= appointment.rrule || "Yes" %></code></p>
              <% } %>
              <p class="completed-label">History</p>
            </div>
            <div class="actions">
              <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>">View</a>
              <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>/edit">Edit</a>
              <form action="/appointments/<%= appointment.id %>/delete" method="POST">
                <button class="button glass-button button-danger" type="submit">Delete</button>
              </form>
            </div>
          </article>
        <% }) %>
      </div>
    <% } %>
  </section>
</div>

<script>
  (() => {
    const modal = document.getElementById("historyModal");
    const openButton = document.getElementById("openHistoryModal");
    const closeButton = document.getElementById("closeHistoryModal");

    if (!modal || !openButton || !closeButton) {
      return;
    }

    const setOpen = (isOpen) => {
      modal.hidden = !isOpen;
      modal.setAttribute("aria-hidden", isOpen ? "false" : "true");
      document.body.classList.toggle("modal-open", isOpen);
    };

    const armOpenButton = () => {
      openButton.disabled = true;
      setTimeout(() => {
        openButton.disabled = false;
      }, 450);
    };

    openButton.addEventListener("click", (event) => {
      if (openButton.disabled) {
        event.preventDefault();
        event.stopPropagation();
        return;
      }

      event.preventDefault();
      event.stopPropagation();
      setOpen(true);
    });

    closeButton.addEventListener("click", (event) => {
      event.preventDefault();
      event.stopPropagation();
      setOpen(false);
    });

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        setOpen(false);
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !modal.hidden) {
        setOpen(false);
      }
    });

    window.addEventListener("pageshow", () => {
      setOpen(false);
      armOpenButton();
    });

    setOpen(false);
    armOpenButton();
  })();
</script>

<script src="/public/livePanelsRefresh.js"></script>
<%- include("partials/bottom") %>
