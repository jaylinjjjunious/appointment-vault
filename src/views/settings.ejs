<%- include("partials/top", { title }) %>
<%
  const safeHistoryAppointments =
    typeof historyAppointments !== "undefined" && Array.isArray(historyAppointments)
      ? historyAppointments
      : [];
  const safeCallStatus = typeof callStatus === "string" ? callStatus : "";
  const safeCallStatusMessage = typeof callStatusMessage === "string" ? callStatusMessage : "";
  const safeTestProfileActive =
    typeof testProfileActive !== "undefined" ? testProfileActive : false;
  const safeTestProfile =
    typeof testProfile !== "undefined" && testProfile ? testProfile : null;
%>

<section class="page-heading">
  <h1>Settings</h1>
  <p>Past appointments are automatically moved into History.</p>
</section>

<% if (safeTestProfileActive && safeTestProfile) { %>
  <section class="calendar-section glass-panel">
    <h2>Temporary Test Profile</h2>
    <p><strong>Name:</strong> <%= safeTestProfile.name %></p>
    <p><strong>Email:</strong> <%= safeTestProfile.email %></p>
    <p class="section-empty">This test profile auto-signs in on every page load.</p>
  </section>
<% } %>

<section class="calendar-section glass-panel">
  <h2>Call Test</h2>
  <p class="section-empty">Use this button to place a live Twilio test call.</p>
  <form class="actions" action="/settings/test-call" method="POST">
    <input type="hidden" name="minutes" value="30" />
    <button class="button glass-button" type="submit">Test Call</button>
  </form>
  <% if (safeCallStatusMessage) { %>
    <p class="<%= safeCallStatus === 'error' ? 'error-text' : '' %>"><%= safeCallStatusMessage %></p>
  <% } %>
</section>

<section class="calendar-section glass-panel">
  <h2>History</h2>
  <p class="section-empty">
    Click below to open your full history log.
    <% if (safeHistoryAppointments.length > 0) { %>
      (<%= safeHistoryAppointments.length %> appointment<%= safeHistoryAppointments.length === 1 ? "" : "s" %>)
    <% } %>
  </p>
  <a
    id="openHistoryModal"
    class="button glass-button button-secondary"
    href="/settings/history"
  >
    View History Log
  </a>
</section>

<div id="historyModal" class="history-modal-backdrop" hidden aria-hidden="true">
  <section class="history-modal glass-panel" role="dialog" aria-modal="true" aria-labelledby="historyModalTitle">
    <div class="history-modal-header">
      <h2 id="historyModalTitle">History Log</h2>
      <button id="closeHistoryModal" class="button glass-button button-secondary" type="button">
        Close
      </button>
    </div>
    <p class="section-empty">
      This history is saved and remembered.
    </p>
    <% if (safeHistoryAppointments.length === 0) { %>
      <p class="section-empty">No past appointments yet.</p>
    <% } else { %>
      <div class="list history-modal-list">
        <% safeHistoryAppointments.forEach((appointment) => { %>
          <article class="card glass-card appointment-card completed-card">
            <div class="appointment-main">
              <h3><strong><%= appointment.title %></strong></h3>
              <p><strong>Date:</strong> <%= appointment.date %></p>
              <p><strong>Time:</strong> <%= formatDisplayTime(appointment.time) %></p>
              <% if (appointment.location) { %>
                <p><strong>Location:</strong> <%= appointment.location %></p>
              <% } %>
              <% if (appointment.reminderMinutes !== null) { %>
                <p><strong>Reminder:</strong> <%= appointment.reminderMinutes %> min before</p>
              <% } %>
              <p class="completed-label">History</p>
            </div>
            <div class="actions">
              <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>">View</a>
              <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>/edit">Edit</a>
              <form action="/appointments/<%= appointment.id %>/delete" method="POST">
                <button class="button glass-button button-danger" type="submit">Delete</button>
              </form>
            </div>
          </article>
        <% }) %>
      </div>
    <% } %>
  </section>
</div>

<script>
  (() => {
    const modal = document.getElementById("historyModal");
    const openButton = document.getElementById("openHistoryModal");
    const closeButton = document.getElementById("closeHistoryModal");

    if (!modal || !openButton || !closeButton) {
      return;
    }

    const setOpen = (isOpen) => {
      modal.hidden = !isOpen;
      modal.setAttribute("aria-hidden", isOpen ? "false" : "true");
      document.body.classList.toggle("modal-open", isOpen);

      if (isOpen) {
        closeButton.focus();
      } else {
        openButton.focus();
      }
    };

    const applyHistoryQueryState = (isOpen) => {
      const url = new URL(window.location.href);
      if (isOpen) {
        url.searchParams.set("history", "open");
      } else {
        url.searchParams.delete("history");
      }
      window.history.replaceState({}, "", url);
    };

    openButton.addEventListener("click", (event) => {
      if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
        return;
      }

      event.preventDefault();
      setOpen(true);
      applyHistoryQueryState(true);
    });

    closeButton.addEventListener("click", (event) => {
      event.preventDefault();
      setOpen(false);
      applyHistoryQueryState(false);
    });

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        setOpen(false);
        applyHistoryQueryState(false);
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !modal.hidden) {
        setOpen(false);
        applyHistoryQueryState(false);
      }
    });

    window.addEventListener("pageshow", () => {
      const params = new URLSearchParams(window.location.search);
      setOpen(params.get("history") === "open");
    });

    const params = new URLSearchParams(window.location.search);
    setOpen(params.get("history") === "open");
  })();
</script>

<script src="/public/livePanelsRefresh.js"></script>
<%- include("partials/bottom") %>
