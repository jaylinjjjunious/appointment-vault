<%- include("partials/top", { title }) %>
<%
  const to12Hour =
    typeof formatDisplayTime === "function"
      ? formatDisplayTime
      : (timeValue) => {
        const value = String(timeValue ?? "").trim();
        const match = /^([01]\d|2[0-3]):([0-5]\d)$/.exec(value);
        if (!match) {
          return value;
        }

        const hour24 = Number.parseInt(match[1], 10);
        const minutes = match[2];
        const meridiem = hour24 >= 12 ? "PM" : "AM";
        const hour12 = hour24 % 12 === 0 ? 12 : hour24 % 12;
        return `${hour12}:${minutes} ${meridiem}`;
      };

  const fallbackAppointments =
    typeof appointments !== "undefined" && Array.isArray(appointments) ? appointments : [];
  const safeTodayAppointments =
    typeof todayAppointments !== "undefined" && Array.isArray(todayAppointments)
      ? todayAppointments
      : [];
  const safeThisWeekAppointments =
    typeof thisWeekAppointments !== "undefined" && Array.isArray(thisWeekAppointments)
      ? thisWeekAppointments
      : [];
  const safeUpcomingAppointments =
    typeof upcomingAppointments !== "undefined" && Array.isArray(upcomingAppointments)
      ? upcomingAppointments
      : safeTodayAppointments.length === 0 && safeThisWeekAppointments.length === 0
        ? fallbackAppointments
        : [];
  const safeTestProfileActive =
    typeof testProfileActive !== "undefined" ? testProfileActive : false;
  const safeTestProfile =
    typeof testProfile !== "undefined" && testProfile ? testProfile : null;
  const todayCount = safeTodayAppointments.length;
  const weekCount = safeThisWeekAppointments.length;
  const upcomingCount = safeUpcomingAppointments.length;
  const totalCount = todayCount + weekCount + upcomingCount;
  const nextFocus =
    safeTodayAppointments.find((appointment) => !appointment.isCompleted) ||
    safeThisWeekAppointments.find((appointment) => !appointment.isCompleted) ||
    safeUpcomingAppointments.find((appointment) => !appointment.isCompleted) ||
    null;
  const hasAnyAppointments = todayCount + weekCount + upcomingCount > 0;
%>

<section id="dashboard-top" class="dashboard-intro glass-panel flex flex-col lg:flex-row lg:items-center gap-6 hero-card">
  <div class="dashboard-intro-main flex-1">
    <p class="hero-kicker">Welcome.</p>
    <h1 class="text-3xl font-bold tracking-tight">üëã Welcome back!</h1>
    <p class="text-base-content/70 mt-2">
      Plan your day, catch conflicts early, and add appointments faster.
    </p>
    <div class="hero-metric">
      <span class="hero-metric-label">Total scheduled</span>
      <strong class="hero-metric-value"><%= totalCount %></strong>
    </div>
  </div>
  <div class="dashboard-stats grid grid-cols-3 gap-3 w-full lg:w-auto">
    <%- include("ui/StatTile", { label: "Today", value: todayCount }) %>
    <%- include("ui/StatTile", { label: "This Week", value: weekCount }) %>
    <%- include("ui/StatTile", { label: "Upcoming", value: upcomingCount }) %>
  </div>
</section>

<div class="section-divider" aria-hidden="true"></div>

<section class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
  <div class="dashboard-main-col lg:col-span-2 space-y-6">
    <section class="card glass-panel quick-add-card" data-toggle-root="quick">
      <div class="toggle-header">
        <h2 class="toggle-title" data-toggle-title>Quick Add</h2>
        <div class="actions">
          <div class="tabs tabs-boxed">
            <a class="tab tab-active" href="#quick-add" data-toggle-target="quick">Quick Add</a>
            <a class="tab" href="#todo" data-toggle-target="todo">To-Do</a>
          </div>
          <a class="glass-button button-secondary" href="/appointments">Open Appointments</a>
          <a class="glass-button button-secondary" href="/appointments/new">Manual Form</a>
        </div>
      </div>

      <div class="toggle-panel mt-4" data-toggle-panel="quick">
        <form class="form-grid space-y-4" action="/agent/parse" method="POST" data-activity="appointment_create" data-activity-title="Created appointment draft" data-activity-field="quickText">
          <div class="form-field">
            <label class="text-sm text-base-content/70" for="quickText">Add appointment in plain language</label>
            <textarea
              id="quickText"
              name="quickText"
              rows="4"
              class="agent-textarea glass-input"
              placeholder="Dentist tomorrow 3pm remind 30&#10;Court 2/25 8:30am&#10;Job interview Friday 10am at 4900 California Ave"
            ></textarea>
          </div>
          <div class="actions flex flex-wrap gap-3">
            <button class="glass-button" type="submit">Create Draft</button>
          </div>
        </form>
        <p class="quick-hint text-xs text-base-content/60 mt-3">
          Examples: ‚ÄúDentist tomorrow 3pm remind 30‚Äù, ‚ÄúCourt 2/25 8:30am‚Äù
        </p>
      </div>

      <div class="toggle-panel mt-4" data-toggle-panel="todo" hidden>
        <form class="form-grid space-y-4" action="/dashboard/todo" method="POST" data-activity="todo_create" data-activity-title="Created To-Do" data-activity-field="todoTitle">
          <div class="form-field">
            <label class="text-sm text-base-content/70" for="todoTitle">Add a To-Do (title)</label>
            <input
              id="todoTitle"
              name="todoTitle"
              class="glass-input"
              type="text"
              placeholder="Call client, prep documents, follow up"
              required
            />
          </div>
          <div class="form-row">
            <div class="form-field">
              <label class="text-sm text-base-content/70" for="todoDate">Date (optional)</label>
              <input id="todoDate" name="todoDate" class="glass-input" type="date" />
            </div>
            <div class="form-field">
              <label class="text-sm text-base-content/70" for="todoTime">Time (optional)</label>
              <input id="todoTime" name="todoTime" class="glass-input" type="time" />
            </div>
          </div>
          <div class="form-field">
            <label class="text-sm text-base-content/70" for="todoDuration">Duration</label>
            <select id="todoDuration" name="todoDuration" class="glass-input">
              <option value="15">15 minutes</option>
              <option value="30" selected>30 minutes</option>
              <option value="45">45 minutes</option>
              <option value="60">60 minutes</option>
            </select>
            <p class="quick-hint">If no date/time is provided, we‚Äôll schedule it for the next full hour.</p>
          </div>
          <div class="actions flex flex-wrap gap-3">
            <button class="glass-button" type="submit">Add To-Do</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <aside class="dashboard-side-col lg:col-span-1 space-y-6">
    <section class="card glass-panel">
      <%- include("ui/SectionHeader", {
        title: "Recent Activity",
        subtitle: "Last 20 actions saved locally",
        actions: ""
      }) %>
      <div class="recent-activity" data-activity-root>
        <div class="skeleton-stack" data-skeleton>
          <%- include("ui/Skeleton", { className: "skeleton-line" }) %>
          <%- include("ui/Skeleton", { className: "skeleton-line" }) %>
          <%- include("ui/Skeleton", { className: "skeleton-line" }) %>
        </div>
        <div class="recent-activity-list" data-activity-list hidden></div>
        <div class="recent-activity-empty" data-activity-empty hidden>
          <%- include("ui/EmptyState", {
            title: "No activity yet",
            message: "Create an appointment or add a To-Do to see activity here.",
            actions: "<a class='button glass-button button-secondary' href='/appointments'>Open Appointments</a>"
          }) %>
        </div>
      </div>
    </section>

    <% if (googleStatusMessage) { %>
      <%- include("ui/Card", {
        className: "status-card",
        body: `<p>${googleStatusMessage}</p>`
      }) %>
    <% } %>

    <% if (safeTestProfileActive && safeTestProfile) { %>
      <section class="card glass-panel status-card">
        <p>
          <strong>Temporary Test Profile:</strong>
          <%= safeTestProfile.name %> (<%= safeTestProfile.email %>)
        </p>
      </section>
    <% } else if (!googleConfigured) { %>
      <section class="card glass-panel status-card warning-card">
        <p>Google Calendar OAuth is not configured yet. Add the required Google env values.</p>
      </section>
    <% } else if (!googleConnected) { %>
      <section class="card glass-panel status-card warning-card">
        <p>Google Calendar is not connected yet.</p>
        <div class="actions mt-3">
          <a class="glass-button" href="/auth/google" data-activity="google_connect" data-activity-title="Connected Google Calendar">Connect Google Calendar</a>
        </div>
      </section>
    <% } %>
  </aside>
</section>
<script src="/public/livePanelsRefresh.js"></script>
<script src="/public/ui-activity.js"></script>
<script src="/public/ui-error-boundary.js"></script>
<script>
  (() => {
    const root = document.querySelector("[data-toggle-root]");
    if (!root) return;

    const title = root.querySelector("[data-toggle-title]");
    const panels = Array.from(root.querySelectorAll("[data-toggle-panel]"));
    const options = Array.from(root.querySelectorAll("[data-toggle-target]"));

    const setActive = (target) => {
      root.setAttribute("data-toggle-root", target);
      panels.forEach((panel) => {
        panel.hidden = panel.getAttribute("data-toggle-panel") !== target;
      });
      options.forEach((option) => {
        const isActive = option.getAttribute("data-toggle-target") === target;
        option.classList.toggle("tab-active", isActive);
      });
      const text = target === "todo" ? "To-Do" : "Quick Add";
      if (title) title.textContent = text;
    };

    options.forEach((option) => {
      option.addEventListener("click", (event) => {
        event.preventDefault();
        const target = option.getAttribute("data-toggle-target");
        if (target) setActive(target);
      });
    });

    setActive(root.getAttribute("data-toggle-root") || "quick");
  })();
</script>
<%- include("partials/bottom") %>
