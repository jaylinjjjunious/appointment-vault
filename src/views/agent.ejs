<%- include("partials/top", { title }) %>
<%
  const to12Hour =
    typeof formatDisplayTime === "function"
      ? formatDisplayTime
      : (timeValue) => {
        const value = String(timeValue ?? "").trim();
        const match = /^([01]\d|2[0-3]):([0-5]\d)$/.exec(value);
        if (!match) {
          return value;
        }

        const hour24 = Number.parseInt(match[1], 10);
        const minutes = match[2];
        const meridiem = hour24 >= 12 ? "PM" : "AM";
        const hour12 = hour24 % 12 === 0 ? 12 : hour24 % 12;
        return `${hour12}:${minutes} ${meridiem}`;
      };
%>

<section class="page-heading glass-panel mb-6">
  <h1 class="text-3xl font-bold tracking-tight">AI Quick Add</h1>
  <p class="text-base-content/70 mt-2">Type it naturally, preview it, then save.</p>
</section>

<section class="dashboard-grid grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="dashboard-main-col space-y-6">
    <section class="card glass-panel">
      <h2 class="text-xl font-semibold">Instant Calendar Log</h2>
      <p class="text-base-content/70 mt-2">
        Type a sentence and we will book it immediately.
      </p>
      <form id="calendarAssistantForm" class="form-grid space-y-4 mt-4">
        <div class="form-field">
          <label class="text-sm text-base-content/70" for="calendarAssistantInput">Appointment request</label>
          <textarea
            id="calendarAssistantInput"
            rows="5"
            class="agent-textarea glass-input"
            placeholder="I have an appointment for 3pm on March 4th"
            required
          ></textarea>
        </div>
        <div class="actions flex flex-wrap gap-3">
          <button class="glass-button" type="submit">Book it</button>
        </div>
      </form>
      <div id="calendarAssistantReply" class="mt-4" hidden>
        <p class="text-sm text-base-content/80" data-reply></p>
        <a class="glass-button button-secondary mt-3" data-calendar-link href="#" target="_blank" rel="noopener noreferrer" hidden>
          Open in Google Calendar
        </a>
      </div>
    </section>

    <section class="card glass-panel">
      <form class="form-grid space-y-4" action="/agent/parse" method="POST">
        <div class="form-field">
          <label class="text-sm text-base-content/70" for="promptText">Tell me your appointment</label>
          <textarea
            id="promptText"
            name="promptText"
            rows="8"
            class="agent-textarea glass-input"
            placeholder="Dentist tomorrow 3pm remind 30"
            hx-post="/agent/preview"
            hx-trigger="keyup changed delay:500ms"
            hx-target="#agentLivePreview"
            hx-indicator="#agentPreviewLoading"
            hx-swap="innerHTML"
          ><%= promptText %></textarea>
          <p id="agentPreviewLoading" class="section-empty htmx-indicator text-xs text-base-content/60">Parsing previewâ€¦</p>
        </div>
        <div class="actions flex flex-wrap gap-3">
          <button class="glass-button" type="submit">Parse</button>
          <a class="glass-button button-secondary" href="/appointments/new">Manual Form</a>
        </div>
      </form>

      <section class="examples mt-6">
        <h2 class="text-lg font-semibold">Example inputs</h2>
        <ul class="mt-3 space-y-2 text-sm text-base-content/70">
          <li>Dentist tomorrow at 3pm, remind me 30 minutes before</li>
          <li>Job interview Friday 10am at 4900 California Ave, notes: bring ID</li>
          <li>Court 2/25 8:30am</li>
        </ul>
      </section>
    </section>
  </div>
  <aside id="agentLivePreview" class="dashboard-side-col space-y-6">
    <%- include("partials/agent-preview", { parsed, previewError: parseError || "" }) %>
  </aside>
</section>

<% if (parseError) { %>
  <section class="card glass-panel error-card">
    <p class="error-text"><%= parseError %></p>
  </section>
<% } %>

<% if (parsed) { %>
  <section class="card glass-panel">
    <h2 class="text-xl font-semibold">Preview</h2>
    <div class="preview-grid mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
      <p><strong>Title:</strong> <%= parsed.title || "Not set" %></p>
      <p><strong>Date:</strong> <%= parsed.date || "Not set" %></p>
      <p><strong>Time:</strong> <%= parsed.time ? to12Hour(parsed.time) : "Not set" %></p>
      <p><strong>Location:</strong> <%= parsed.location || "None" %></p>
      <p><strong>Reminder:</strong> <%= parsed.reminderMinutes === "" ? "None" : parsed.reminderMinutes + " min" %></p>
      <p><strong>Recurring:</strong> <%= parsed.isRecurring ? "Yes" : "No" %></p>
      <% if (parsed.isRecurring && parsed.rrule) { %>
        <p><strong>RRULE:</strong> <code><%= parsed.rrule %></code></p>
      <% } %>
      <p><strong>Tags:</strong> <%= parsed.tags || "None" %></p>
      <p class="preview-notes"><strong>Notes:</strong> <%= parsed.notes || "None" %></p>
    </div>

    <form class="form-grid mt-6 space-y-4" action="/agent/save" method="POST">
      <input type="hidden" name="promptText" value="<%= promptText %>" />

      <details class="edit-details" <%= Object.keys(saveErrors).length > 0 ? "open" : "" %>>
        <summary class="cursor-pointer text-sm text-base-content/70">Edit details</summary>

        <div class="form-field">
          <label for="title">Title</label>
          <input id="title" class="glass-input" name="title" type="text" value="<%= parsed.title %>" required />
          <% if (saveErrors.title) { %><p class="field-error"><%= saveErrors.title %></p><% } %>
        </div>

        <div class="form-row grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-field">
            <label for="date">Date</label>
            <input id="date" class="glass-input" name="date" type="date" value="<%= parsed.date %>" required />
            <% if (saveErrors.date) { %><p class="field-error"><%= saveErrors.date %></p><% } %>
          </div>

          <div class="form-field">
            <label for="time">Time</label>
            <input id="time" class="glass-input" name="time" type="time" value="<%= parsed.time %>" required />
            <% if (saveErrors.time) { %><p class="field-error"><%= saveErrors.time %></p><% } %>
          </div>
        </div>

        <div class="form-field">
          <label class="checkbox-field" for="isRecurring">
            <input
              id="isRecurring"
              name="isRecurring"
              type="checkbox"
              value="true"
              <%= parsed.isRecurring ? "checked" : "" %>
            />
            <span>Recurring appointment</span>
          </label>
        </div>

        <div class="form-field">
          <label for="rrule">RRULE</label>
          <input
            id="rrule"
            class="glass-input"
            name="rrule"
            type="text"
            value="<%= parsed.rrule || '' %>"
            placeholder="FREQ=WEEKLY;INTERVAL=1;BYDAY=MO,WE,FR"
          />
          <% if (saveErrors.rrule) { %><p class="field-error"><%= saveErrors.rrule %></p><% } %>
        </div>

        <div class="form-field">
          <label for="location">Location</label>
          <input id="location" class="glass-input" name="location" type="text" value="<%= parsed.location %>" />
        </div>

        <div class="form-row grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-field">
            <label for="tags">Tags (comma-separated)</label>
            <input id="tags" class="glass-input" name="tags" type="text" value="<%= parsed.tags %>" />
          </div>

          <div class="form-field">
            <label for="reminderMinutes">Reminder Minutes</label>
            <input
              id="reminderMinutes"
              class="glass-input"
              name="reminderMinutes"
              type="number"
              min="0"
              step="1"
              value="<%= parsed.reminderMinutes %>"
            />
          </div>
        </div>

        <div class="form-field">
          <label for="notes">Notes</label>
          <textarea id="notes" class="glass-input" name="notes" rows="4"><%= parsed.notes %></textarea>
        </div>
      </details>

      <% if (saveErrors.title || saveErrors.date || saveErrors.time) { %>
        <p class="field-error">Please fix required fields (title, date, time) before saving.</p>
      <% } %>

      <div class="actions flex flex-wrap gap-3">
        <button class="glass-button" type="submit">Save it</button>
      </div>
    </form>
  </section>
<% } %>

<script>
  (() => {
    const form = document.getElementById("calendarAssistantForm");
    const input = document.getElementById("calendarAssistantInput");
    const replyWrap = document.getElementById("calendarAssistantReply");
    const replyText = replyWrap?.querySelector("[data-reply]");
    const calendarLink = replyWrap?.querySelector("[data-calendar-link]");

    if (!form || !input || !replyWrap || !replyText || !calendarLink) {
      return;
    }

    let pendingContext = null;

    const renderReply = (text, link) => {
      replyText.textContent = text || "";
      replyWrap.hidden = false;
      if (link) {
        calendarLink.href = link;
        calendarLink.hidden = false;
      } else {
        calendarLink.hidden = true;
      }
    };

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const raw = String(input.value || "").trim();
      if (!raw) {
        return;
      }

      const message = pendingContext
        ? `${pendingContext.original}\nClarification answer: ${raw}`
        : raw;

      replyWrap.hidden = true;
      try {
        const response = await fetch("/api/assistant/calendar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await response.json();
        if (!response.ok) {
          renderReply(data?.message || "Something went wrong. Please try again.");
          return;
        }

        renderReply(data?.reply || "Done.", data?.calendar?.htmlLink || "");
        if (data?.needs_clarification) {
          pendingContext = { original: pendingContext?.original || raw };
        } else {
          pendingContext = null;
        }
      } catch (error) {
        renderReply("Unable to reach the server. Please try again.");
      }
    });
  })();
</script>

<%- include("partials/bottom") %>
