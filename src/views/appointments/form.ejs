<%- include("../partials/top", { title }) %>

<section class="page-heading">
  <h1><%= pageTitle %></h1>
  <% if (quickAddMode) { %>
    <p>Quick Add Mode: only title, date, and time are required.</p>
  <% } else { %>
    <p>Update appointment details below.</p>
  <% } %>
</section>

<section class="card glass-panel">
  <div class="page-actions">
    <a class="button glass-button button-secondary" href="/appointments">Back to Appointments</a>
    <% if (appointment && appointment.id) { %>
      <a class="button glass-button button-secondary" href="/appointments/<%= appointment.id %>">View Appointment</a>
    <% } %>
  </div>
  <form
    class="form-grid"
    action="<%= formAction %>"
    method="POST"
    novalidate
    data-tab-root
    data-activity="<%= appointment && appointment.id ? 'appointment_update' : 'appointment_create' %>"
    data-activity-title="<%= appointment && appointment.id ? 'Updated appointment' : 'Created appointment' %>"
    data-activity-field="title"
  >
    <div class="tabs tabs-boxed">
      <a class="tab tab-active" href="#details" data-tab="details">Details</a>
      <a class="tab" href="#reminders" data-tab="reminders">Reminders</a>
    </div>

    <div class="form-field">
      <label for="title">Title *</label>
      <input
        id="title"
        class="glass-input"
        name="title"
        type="text"
        value="<%= appointment.title %>"
        required
        aria-invalid="<%= errors.title ? 'true' : 'false' %>"
      />
      <% if (errors.title) { %>
        <p class="field-error"><%= errors.title %></p>
      <% } %>
    </div>

    <section data-tab-panel="details">
      <div class="form-row">
      <div class="form-field">
        <label for="date">Date (YYYY-MM-DD) *</label>
        <input
          id="date"
          class="glass-input"
          name="date"
          type="date"
          value="<%= appointment.date %>"
          required
          aria-invalid="<%= errors.date ? 'true' : 'false' %>"
        />
        <% if (errors.date) { %>
          <p class="field-error"><%= errors.date %></p>
        <% } %>
      </div>

      <div class="form-field">
        <label for="time">Time (HH:MM) *</label>
        <input
          id="time"
          class="glass-input"
          name="time"
          type="time"
          value="<%= appointment.time %>"
          required
          aria-invalid="<%= errors.time ? 'true' : 'false' %>"
        />
        <% if (errors.time) { %>
          <p class="field-error"><%= errors.time %></p>
        <% } %>
      </div>
    </div>

      <div class="form-field">
        <label for="location">Location</label>
        <input id="location" class="glass-input" name="location" type="text" value="<%= appointment.location %>" />
      </div>

      <div class="form-field">
        <label for="tags">Tags (comma-separated)</label>
        <input id="tags" class="glass-input" name="tags" type="text" value="<%= appointment.tags %>" />
      </div>

      <div class="form-field">
        <label for="notes">Notes</label>
        <textarea id="notes" class="glass-input" name="notes" rows="5"><%= appointment.notes %></textarea>
      </div>
    </section>

    <section data-tab-panel="reminders" hidden>
      <div class="form-field">
        <label for="reminderMinutes">Reminder Minutes</label>
        <input
          id="reminderMinutes"
          class="glass-input"
          name="reminderMinutes"
          type="number"
          min="0"
          step="1"
          value="<%= appointment.reminderMinutes %>"
        />
      </div>

      <div class="form-field">
        <label class="checkbox-field" for="isRecurring">
          <input
            id="isRecurring"
            name="isRecurring"
            type="checkbox"
            value="true"
            <%= appointment.isRecurring ? "checked" : "" %>
          />
          <span>Recurring appointment</span>
        </label>
      </div>

      <div class="form-field">
        <label for="rrule">RRULE</label>
        <input
          id="rrule"
          class="glass-input"
          name="rrule"
          type="text"
          value="<%= appointment.rrule || '' %>"
          placeholder="FREQ=WEEKLY;INTERVAL=1;BYDAY=MO,WE,FR"
        />
        <p class="section-empty">
          Example: <code>FREQ=WEEKLY;INTERVAL=1;BYDAY=MO,WE,FR</code>
        </p>
        <% if (errors.rrule) { %>
          <p class="field-error"><%= errors.rrule %></p>
        <% } %>
      </div>
    </section>

    <div class="actions">
      <button class="button glass-button" type="submit"><%= submitLabel %></button>
      <a class="button glass-button button-secondary" href="/dashboard">Cancel</a>
    </div>
  </form>
</section>

<script>
  (() => {
    const root = document.querySelector("[data-tab-root]");
    if (!root) return;
    const tabs = Array.from(root.querySelectorAll("[data-tab]"));
    const panels = Array.from(root.querySelectorAll("[data-tab-panel]"));
    const activate = (key) => {
      panels.forEach((panel) => {
        panel.hidden = panel.getAttribute("data-tab-panel") !== key;
      });
      tabs.forEach((tab) => {
        const isActive = tab.getAttribute("data-tab") === key;
        tab.classList.toggle("tab-active", isActive);
      });
    };
    const hash = window.location.hash.replace("#", "");
    const initial = tabs.some((tab) => tab.getAttribute("data-tab") === hash) ? hash : "details";
    activate(initial);
    tabs.forEach((tab) => {
      tab.addEventListener("click", (event) => {
        const key = tab.getAttribute("data-tab");
        if (!key) return;
        event.preventDefault();
        history.replaceState(null, "", `#${key}`);
        activate(key);
      });
    });
  })();
</script>

<%- include("../partials/bottom") %>
